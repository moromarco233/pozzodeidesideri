<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Pozzo dei Desideri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=EB+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* [TUTTI GLI STILI CSS RIMANGONO UGUALI - NON MODIFICATI] */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'EB Garamond', 'Georgia', serif;
      color: #f5f7fb;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      line-height: 1.6;
      background: #0a0e1a;
    }

    /* ============ CIELO NOTTURNO REALISTICO ============ */
    #night-sky {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -100;
      pointer-events: none;
      display: block;
      background: linear-gradient(to bottom, 
        #050510 0%,
        #0a1525 20%,
        #1a2b4a 40%,
        #0a1525 70%,
        #050510 100%
      );
    }

    /* Stelle */
    .star {
      position: absolute;
      background-color: white;
      border-radius: 50%;
      opacity: 0;
      animation: twinkle 3s infinite alternate;
    }

    .star-small {
      width: 1px;
      height: 1px;
    }

    .star-medium {
      width: 2px;
      height: 2px;
    }

    .star-large {
      width: 3px;
      height: 3px;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    }

    /* Stelle colorate */
    .star-blue {
      background-color: #b6d0ff;
      box-shadow: 0 0 6px #b6d0ff;
    }

    .star-yellow {
      background-color: #fff9b6;
      box-shadow: 0 0 6px #fff9b6;
    }

    /* Costellazione Bilancia (aggiunta) */
    .libra-constellation {
      position: fixed;
      top: 20%;
      right: 15%;
      width: 120px;
      height: 80px;
      z-index: -99;
    }

    .libra-star {
      position: absolute;
      width: 5px;
      height: 5px;
      background-color: #ffd700;
      border-radius: 50%;
      box-shadow: 0 0 10px 3px rgba(255, 215, 0, 0.7);
      animation: constellationGlow 4s infinite alternate;
    }

    .libra-line {
      position: absolute;
      background-color: rgba(255, 215, 0, 0.5);
      height: 2px;
      transform-origin: left center;
      animation: constellationGlow 4s infinite alternate;
    }

    /* Posizioni stelle Bilancia */
    .libra-star:nth-child(1) { top: 15px; left: 35px; }
    .libra-star:nth-child(2) { top: 45px; left: 15px; }
    .libra-star:nth-child(3) { top: 45px; left: 55px; }
    .libra-star:nth-child(4) { top: 75px; left: 25px; }
    .libra-star:nth-child(5) { top: 75px; left: 65px; }

    /* Linee che collegano le stelle */
    .libra-line:nth-child(6) {
      top: 17px;
      left: 37px;
      width: 30px;
      transform: rotate(-45deg);
    }

    .libra-line:nth-child(7) {
      top: 17px;
      left: 37px;
      width: 35px;
      transform: rotate(20deg);
    }

    .libra-line:nth-child(8) {
      top: 47px;
      left: 17px;
      width: 30px;
      transform: rotate(70deg);
    }

    .libra-line:nth-child(9) {
      top: 47px;
      left: 57px;
      width: 30px;
      transform: rotate(110deg);
    }

    /* Stelle cadenti casuali - stile aggiornato */
    .shooting-star {
      position: absolute;
      border-radius: 50%;
      z-index: -98;
      opacity: 0;
      background-color: white;
      box-shadow: 
        0 0 4px 2px rgba(255, 255, 255, 0.7),
        0 0 8px 4px rgba(255, 255, 255, 0.3);
    }

    .shooting-star-trail {
      position: absolute;
      height: 1px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.8) 20%, 
        rgba(255, 255, 255, 0.4) 60%, 
        transparent 100%);
      transform-origin: left center;
      z-index: -99;
      opacity: 0;
      filter: blur(0.5px);
    }

    /* Varianti casuali per dimensioni */
    .shooting-star.small {
      width: 1px;
      height: 1px;
    }

    .shooting-star.medium {
      width: 2px;
      height: 2px;
    }

    .shooting-star.large {
      width: 3px;
      height: 3px;
      box-shadow: 
        0 0 6px 3px rgba(255, 255, 255, 0.8),
        0 0 12px 6px rgba(255, 255, 255, 0.4);
    }

    /* Varianti per colore (casuale) */
    .shooting-star.blue {
      background-color: #b6d0ff;
      box-shadow: 
        0 0 4px 2px rgba(182, 208, 255, 0.7),
        0 0 8px 4px rgba(182, 208, 255, 0.3);
    }

    .shooting-star.yellow {
      background-color: #fff9b6;
      box-shadow: 
        0 0 4px 2px rgba(255, 249, 182, 0.7),
        0 0 8px 4px rgba(255, 249, 182, 0.3);
    }

    /* ============ ANIMAZIONE MONETA VOLANTE DIRETTA ============ */
    .flying-coin {
      position: fixed;
      width: 60px;
      height: 60px;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transform-origin: center;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7));
      will-change: transform, opacity;
    }

    .flying-coin svg {
      width: 100%;
      height: 100%;
      animation: coinSpin 1s linear infinite;
    }

    .coin-trail {
      position: fixed;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.8) 20%, 
        rgba(255, 255, 255, 0.5) 50%, 
        rgba(255, 255, 255, 0.2) 80%, 
        transparent 100%);
      z-index: 999;
      pointer-events: none;
      opacity: 0;
      filter: blur(1px);
      transform-origin: left center;
    }

    /* ============ ANIMAZIONE POZZO ============ */
    .well-image-container {
      width: 100%;
      max-width: 500px;
      height: 300px;
      margin: 40px auto 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: transparent;
      border: none;
      overflow: hidden;
    }

    .image-inner-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .well-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
      background: transparent;
      border: none;
      box-shadow: none;
      filter: drop-shadow(0 0 5px rgba(192,192,255,0.1));
      position: relative;
      z-index: 1;
      transition: all 0.5s ease;
    }

    .well-image:hover {
      filter: drop-shadow(0 0 15px rgba(192,192,255,0.3));
      transform: scale(1.02);
    }

    /* Cerchio target per l'entrata della moneta */
    .well-target {
      position: absolute;
      width: 60px;
      height: 60px;
      border: 2px dashed rgba(192, 192, 255, 0.5);
      border-radius: 50%;
      z-index: 10;
      pointer-events: none;
      opacity: 0;
      animation: pulseTarget 2s ease-in-out infinite;
    }

    /* Effetto splash quando la moneta entra */
    .splash-effect {
      position: absolute;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: radial-gradient(circle, 
        rgba(192, 192, 255, 0.4) 0%, 
        rgba(128, 128, 255, 0.3) 30%, 
        rgba(64, 64, 255, 0.2) 60%, 
        transparent 70%);
      z-index: 5;
      pointer-events: none;
      opacity: 0;
      transform: scale(0);
      filter: blur(5px);
    }

    /* ============ RESTO DEL TUO STILE ORIGINALE ============ */
    .balance-background {
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(circle at 15% 50%, rgba(255,255,255,0.05) 0%, transparent 70%),
        radial-gradient(circle at 85% 50%, rgba(255,255,255,0.05) 0%, transparent 70%),
        linear-gradient(90deg, transparent 48%, rgba(255,255,255,0.03) 49%, rgba(255,255,255,0.03) 51%, transparent 52%);
      z-index: -3;
      opacity: 0.3;
    }

    .container {
      max-width: 820px;
      margin: 60px auto;
      padding: 38px 26px;
      background: radial-gradient(circle at top, rgba(14,20,40,0.95), rgba(8,12,24,0.98));
      border-radius: 26px;
      border: 1px solid rgba(200,200,255,0.15);
      box-shadow:
        0 22px 60px rgba(0,0,0,0.85),
        0 0 0 1px rgba(255,255,255,0.02),
        inset 0 0 30px rgba(255,255,255,0.03);
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 25px 20px 10px;
      position: relative;
    }

    .header::before,
    .header::after {
      content: "★";
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2rem;
      color: rgba(192,192,255,0.4);
    }

    .header::before { left: 0; }
    .header::after { right: 0; }

    h1 {
      font-family: 'Cinzel', serif;
      font-size: 2.8rem;
      color: #f0f0f0;
      letter-spacing: 0.15em;
      text-shadow:
        0 0 20px rgba(192,192,255,0.7),
        0 0 40px rgba(0,0,0,0.9);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #c0c0c0;
      font-size: 1.2rem;
      text-shadow: 0 0 10px rgba(0,0,0,0.85);
      margin-top: 10px;
    }

    /* ============ PERGAMENA REALISTICA ORIGINALE ============ */
    .wish-form {
      background: transparent;
      padding: 20px 0;
      margin-top: 20px;
      position: relative;
    }

    .parchment-container {
      position: relative;
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      transition: all 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      perspective: 1000px;
    }

    .parchment-wrapper {
      position: relative;
      width: 100%;
      transform-style: preserve-3d;
      transition: transform 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    /* Pergamena base - stile originale */
    .parchment {
      width: 100%;
      min-height: 280px;
      padding: 35px 50px;
      font-size: 1.3rem;
      background: 
        linear-gradient(to bottom, 
          #f7f0d9 0%, 
          #f4e9c9 15%,
          #ecdbb3 40%,
          #e2cf9e 70%,
          #d8c28b 100%),
        url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.2' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
      border-radius: 3px;
      color: #2a1f0a;
      line-height: 1.7;
      resize: none;
      border: none;
      font-family: 'Dancing Script', cursive;
      font-weight: 500;
      letter-spacing: 0.4px;
      box-shadow: 
        inset 0 0 40px rgba(139, 115, 64, 0.4),
        inset 0 0 80px rgba(139, 115, 64, 0.25),
        inset 15px 0 25px -15px rgba(139, 115, 64, 0.7),
        inset -15px 0 25px -15px rgba(139, 115, 64, 0.7),
        inset 0 15px 25px -15px rgba(139, 115, 64, 0.5),
        inset 0 -15px 25px -15px rgba(139, 115, 64, 0.5),
        0 20px 60px rgba(0, 0, 0, 0.9),
        0 8px 25px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(139, 115, 64, 0.4),
        0 0 0 2px rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      transform-origin: center center;
    }

    /* Effetti speciali pergamena - bordi sbiaditi e texture antichizzata */
    .parchment::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(to right, 
          transparent 0%, 
          rgba(139, 115, 64, 0.03) 5%, 
          transparent 10%, 
          transparent 90%, 
          rgba(139, 115, 64, 0.03) 95%, 
          transparent 100%),
        linear-gradient(to bottom, 
          transparent 0%, 
          rgba(139, 115, 64, 0.03) 5%, 
          transparent 10%, 
          transparent 90%, 
          rgba(139, 115, 64, 0.03) 95%, 
          transparent 100%);
      pointer-events: none;
      z-index: 1;
    }

    .parchment::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 30% 40%, rgba(139, 115, 64, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 70% 60%, rgba(139, 115, 64, 0.04) 0%, transparent 50%),
        radial-gradient(circle at 20% 80%, rgba(101, 84, 46, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: 1;
      opacity: 0.6;
    }

    /* Macchie di invecchiamento sulla pergamena - INTENSIFICATE */
    .parchment-age-spots {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      background-image: 
        radial-gradient(circle at 15% 25%, rgba(139, 115,64, 0.12) 4px, transparent 6px),
        radial-gradient(circle at 85% 75%, rgba(139, 115, 64, 0.15) 5px, transparent 7px),
        radial-gradient(circle at 35% 65%, rgba(101, 84, 46, 0.10) 3px, transparent 5px),
        radial-gradient(circle at 65% 35%, rgba(101, 84, 46, 0.10) 3px, transparent 5px),
        radial-gradient(circle at 10% 85%, rgba(80, 66, 36, 0.08) 6px, transparent 8px),
        radial-gradient(circle at 90% 15%, rgba(80, 66, 36, 0.08) 4px, transparent 6px);
      background-size: 120px 120px, 180px 180px, 150px 150px, 140px 140px, 200px 200px, 160px 160px;
      z-index: 1;
      opacity: 0.8;
    }

    /* Bordi arrotolati - più pronunciati */
    .parchment-rolled-edges {
      position: absolute;
      top: 0;
      left: -10px;
      right: -10px;
      height: 30px;
      background: #d8c28b;
      border-radius: 50% 50% 0 0;
      z-index: 0;
      box-shadow: 
        0 3px 8px rgba(0,0,0,0.4),
        inset 0 2px 3px rgba(255,255,255,0.6);
      opacity: 0.8;
      transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    .parchment-rolled-edges.bottom {
      top: auto;
      bottom: 0;
      border-radius: 0 0 50% 50%;
      box-shadow: 
        0 -3px 8px rgba(0,0,0,0.4),
        inset 0 -2px 3px rgba(255,255,255,0.6);
    }

    /* Chiodi decorativi - stile antico */
    .parchment-nail {
      position: absolute;
      width: 16px;
      height: 16px;
      background: radial-gradient(circle at 30% 30%, #a8a8a8, #6b6b6b);
      border-radius: 50%;
      z-index: 3;
      box-shadow: 
        0 2px 6px rgba(0,0,0,0.7),
        inset 0 1px 2px rgba(255,255,255,0.4),
        0 0 0 1px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    .parchment-nail.top-left {
      top: 8px;
      left: 30px;
    }

    .parchment-nail.top-right {
      top: 8px;
      right: 30px;
    }

    .parchment-nail.bottom-left {
      bottom: 8px;
      left: 30px;
    }

    .parchment-nail.bottom-right {
      bottom: 8px;
      right: 30px;
    }

    /* Quando la pergamena è in focus */
    .parchment:focus {
      box-shadow: 
        inset 0 0 40px rgba(139, 115, 64, 0.5),
        inset 0 0 80px rgba(139, 115, 64, 0.35),
        inset 15px 0 25px -15px rgba(139, 115, 64, 0.9),
        inset -15px 0 25px -15px rgba(139, 115,64, 0.9),
        inset 0 15px 25px -15px rgba(139, 115, 64, 0.6),
        inset 0 -15px 25px -15px rgba(139, 115, 64, 0.6),
        0 25px 70px rgba(0, 0, 0, 1),
        0 10px 30px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(139, 115, 64, 0.5),
        0 0 0 2px rgba(255, 255, 255, 0.1),
        0 0 30px rgba(192, 192, 255, 0.4);
      outline: none;
    }

    /* Testo placeholder nella pergamena */
    .parchment::placeholder {
      color: #8b7340;
      font-style: italic;
      text-align: center;
      font-size: 1.4rem;
      opacity: 0.9;
      font-weight: 600;
      letter-spacing: 0.3px;
      padding-top: 5px;
      line-height: 1.4;
    }

    /* Progress bar per pergamena */
    .parchment-progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(139, 115, 64, 0.3);
      border-radius: 2px;
      overflow: hidden;
      margin: 20px 0;
      display: none;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
    }

    .parchment-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #8b7340 0%, #b2995a 50%, #d4b97a 100%);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 2px;
      box-shadow: 0 0 15px rgba(178, 153, 90, 0.7);
      position: relative;
      overflow: hidden;
    }

    .parchment-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        transparent 0%,
        rgba(255, 255, 255, 0.4) 50%,
        transparent 100%);
      animation: shimmer 2s infinite;
    }

    /* Contatore caratteri */
    .char-count {
      text-align: center;
      color: #b2995a;
      font-size: 1rem;
      margin: 15px 0 25px;
      transition: all 0.3s ease;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-shadow: 0 0 10px rgba(178, 153, 90, 0.3);
    }

    /* ============ BOTTONE MONETA - ORIGINALE ============ */
    .coin-button {
      position: relative;
      padding: 24px 60px;
      font-size: 1.5rem;
      font-weight: bold;
      background: linear-gradient(145deg, 
        rgba(255, 255, 255, 0.95) 0%,
        rgba(230, 230, 230, 0.9) 30%,
        rgba(210, 210, 210, 0.85) 70%,
        rgba(190, 190, 190, 0.8) 100%);
      color: #1a1a2a;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      margin: 30px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      box-shadow:
        0 10px 0 #888888,
        0 24px 40px rgba(0,0,0,0.85),
        0 0 22px rgba(255, 255, 255, 0.6),
        inset 0 1px 0 rgba(255,255,255,0.8);
      font-family: 'Cinzel', serif;
      letter-spacing: 1.5px;
      transition: all 0.3s ease;
      text-shadow: 
        0 0 10px rgba(255,255,255,0.8),
        0 0 20px rgba(255,255,255,0.5);
      animation: buttonGlow 4s ease-in-out infinite alternate;
      min-height: 80px;
    }

    /* Testo del bottone - più grande e alto */
    .coin-button .button-text {
      font-size: 1.5rem;
      font-weight: 900;
      letter-spacing: 2px;
      line-height: 1.2;
      text-transform: uppercase;
      padding: 5px 0;
      text-shadow: 
        0 1px 0 rgba(255,255,255,0.9),
        0 2px 4px rgba(0,0,0,0.3),
        0 0 20px rgba(255, 255, 255, 0.7);
      background: linear-gradient(45deg, 
        rgba(30,30,30,0.9) 0%, 
        rgba(50,50,50,0.9) 50%, 
        rgba(30,30,30,0.9) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      position: relative;
      z-index: 2;
    }

    /* Icona moneta - ARGENTO MIGLIORATO */
    .coin-icon {
      width: 60px;
      height: 60px;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5));
      transition: all 0.4s ease;
      flex-shrink: 0;
      position: relative;
      z-index: 2;
    }

    /* Effetto glow sulla moneta */
    .coin-icon::after {
      content: '';
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 50%;
      z-index: -1;
    }

    /* Effetti hover sul bottone */
    .coin-button:hover {
      transform: translateY(-3px);
      box-shadow:
        0 13px 0 #888888,
        0 30px 50px rgba(0,0,0,0.9),
        0 0 35px rgba(255, 255, 255, 0.9),
        inset 0 1px 0 rgba(255,255,255,1);
    }

    .coin-button:hover .coin-icon {
      transform: rotate(15deg) scale(1.15);
      filter: drop-shadow(0 4px 12px rgba(255, 255, 255, 0.8));
    }

    .coin-button:hover .coin-icon::after {
      opacity: 0.6;
    }

    .coin-button:hover .button-text {
      text-shadow: 
        0 1px 0 rgba(255,255,255,1),
        0 2px 8px rgba(0,0,0,0.4),
        0 0 30px rgba(255, 255, 255, 0.9);
    }

    /* Effetto click */
    .coin-button:active {
      transform: translateY(2px);
      box-shadow:
        0 8px 0 #888888,
        0 20px 35px rgba(0,0,0,0.85),
        0 0 25px rgba(255, 255, 255, 0.8);
    }

    .coin-button:active .coin-icon {
      transform: rotate(-5deg) scale(0.95);
      transition: transform 0.1s ease;
    }

    /* Bottone disabilitato */
    .coin-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      animation: none;
    }

    .coin-button:disabled .coin-icon {
      filter: grayscale(0.7) brightness(0.7);
      animation: none;
    }

    /* Effetto speciale quando il bottone è cliccabile */
    .coin-button:not(:disabled) .coin-icon {
      animation: coinGlow 3s infinite alternate;
    }

    /* ============ ANIMAZIONI PRINCIPALI ============ */
    /* Animazione volo diretto della moneta */
    @keyframes coinDirectFlight {
      0% {
        opacity: 1;
        transform: 
          translate(var(--start-x, 0px), var(--start-y, 0px))
          rotate(0deg)
          scale(1);
        filter: 
          drop-shadow(0 0 8px rgba(255, 255, 255, 0.9))
          brightness(1.2);
      }
      40% {
        opacity: 0.95;
        transform: 
          translate(
            calc(var(--start-x, 0px) + var(--delta-x, 0px) * 0.4),
            calc(var(--start-y, 0px) + var(--delta-y, 0px) * 0.4)
          )
          rotate(144deg)
          scale(1.1);
        filter: 
          drop-shadow(0 0 12px rgba(255, 255, 255, 1))
          brightness(1.5);
      }
      80% {
        opacity: 0.9;
        transform: 
          translate(
            calc(var(--start-x, 0px) + var(--delta-x, 0px) * 0.8),
            calc(var(--start-y, 0px) + var(--delta-y, 0px) * 0.8)
          )
          rotate(288deg)
          scale(0.9);
        filter: 
          drop-shadow(0 0 15px rgba(255, 255, 255, 1.2))
          brightness(1.8);
      }
      100% {
        opacity: 0;
        transform: 
          translate(var(--end-x, 0px), var(--end-y, 0px))
          rotate(360deg)
          scale(0.7);
        filter: 
          drop-shadow(0 0 20px rgba(255, 255, 255, 1.5))
          brightness(2);
      }
    }

    /* Animazione scia */
    @keyframes trailDirectGrow {
      0% {
        width: 0;
        opacity: 0;
        transform: rotate(var(--angle, 0rad)) scaleX(0);
      }
      10% {
        opacity: 0.8;
        transform: rotate(var(--angle, 0rad)) scaleX(0.1);
      }
      90% {
        opacity: 0.4;
        transform: rotate(var(--angle, 0rad)) scaleX(0.9);
      }
      100% {
        width: var(--distance, 400px);
        opacity: 0;
        transform: rotate(var(--angle, 0rad)) scaleX(1);
      }
    }

    /* Animazione splash finale */
    @keyframes splashEffect {
      0% {
        opacity: 0;
        transform: scale(0);
        filter: blur(0px);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.2);
        filter: blur(3px);
      }
      100% {
        opacity: 0;
        transform: scale(1.5);
        filter: blur(5px);
      }
    }

    /* Animazione target */
    @keyframes pulseTarget {
      0%, 100% {
        opacity: 0;
        transform: scale(0.8);
        border-color: rgba(192, 192, 255, 0.3);
      }
      50% {
        opacity: 0.5;
        transform: scale(1);
        border-color: rgba(192, 192, 255, 0.8);
      }
    }

    /* Altre animazioni ORIGINALI */
    @keyframes coinSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes coinGlow {
      0% {
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)) brightness(1);
      }
      100% {
        filter: drop-shadow(0 2px 12px rgba(255, 255, 255, 0.6)) brightness(1.3);
      }
    }

    @keyframes buttonGlow {
      0% { 
        text-shadow: 
          0 0 8px rgba(255,255,255,0.7),
          0 0 16px rgba(255,255,255,0.4);
        box-shadow:
          0 10px 0 #888888,
          0 24px 40px rgba(0,0,0,0.85),
          0 0 20px rgba(255, 255, 255, 0.5);
      }
      100% { 
        text-shadow: 
          0 0 15px rgba(255,255,255,1),
          0 0 30px rgba(255,255,255,0.7),
          0 0 45px rgba(255,255,255,0.4);
        box-shadow:
          0 10px 0 #888888,
          0 24px 40px rgba(0,0,0,0.85),
          0 0 40px rgba(255, 255, 255, 0.9);
      }
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    @keyframes constellationGlow {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    @keyframes shootingStar {
      0% {
        opacity: 0;
        transform: translate(0, 0);
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 0.8;
      }
      100% {
        opacity: 0;
        transform: translate(var(--end-x, 800px), var(--end-y, 400px));
      }
    }

    @keyframes parchmentGlow {
      0%, 100% { 
        box-shadow: 
          inset 0 0 40px rgba(139, 115, 64, 0.4),
          0 20px 60px rgba(0, 0, 0, 0.9),
          0 0 0 1px rgba(139, 115, 64, 0.4);
      }
      50% { 
        box-shadow: 
          inset 0 0 40px rgba(139, 115, 64, 0.6),
          0 20px 60px rgba(0, 0, 0, 1),
          0 0 0 1px rgba(178, 153, 90, 0.6),
          0 0 30px rgba(192, 192, 255, 0.5);
      }
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    @keyframes rollParchment {
      0% {
        transform: scaleY(1) scaleX(1);
        opacity: 1;
      }
      50% {
        transform: scaleY(0.3) scaleX(1.1);
        opacity: 0.7;
      }
      100% {
        transform: scaleY(0.1) scaleX(1.2);
        opacity: 0;
      }
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) rotate(10deg);
        opacity: 0;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-out {
      animation: fadeOut 0.8s ease-out forwards;
    }

    @keyframes fadeOut {
      to { opacity: 0; transform: translateY(-30px); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s ease-in-out;
    }

    .hidden { display: none !important; }

    .silver-text {
      color: #e0e0e0;
      text-shadow: 0 0 8px rgba(192,192,255,0.5);
    }

    /* ============ ALTRI STILI ORIGINALI ============ */
    .privacy-note {
      text-align: center;
      color: #a0a8c0;
      font-size: 0.9rem;
      margin-top: 20px;
      font-style: italic;
      line-height: 1.5;
    }

    .confirmation {
      background: radial-gradient(circle at top, rgba(30,40,60,0.2), rgba(10,15,25,0.98));
      border: 1px solid rgba(200,200,255,0.3);
      border-radius: 20px;
      padding: 40px;
      margin: 40px auto;
      display: none;
      text-align: center;
      animation: fadeIn 1.1s ease-out;
      max-width: 600px;
    }

    .confirmation h2 {
      color: #e0e0e0;
      margin-bottom: 20px;
      font-size: 2.2rem;
      text-shadow: 0 0 12px rgba(192,192,255,0.6);
    }

    .confirmation p {
      font-size: 1.3rem;
      line-height: 1.8;
      color: #f0e6d2;
      margin-bottom: 20px;
    }

    .offer-section {
      background: radial-gradient(circle at top, rgba(30,40,60,0.2), rgba(10,15,25,0.98));
      border: 1px solid rgba(200,200,255,0.3);
      border-radius: 20px;
      padding: 40px;
      margin: 40px auto;
      display: none;
      text-align: center;
      animation: fadeIn 1.1s ease-out;
      max-width: 600px;
    }

    .offer-title {
      color: #c0c0c0;
      font-size: 1.8rem;
      margin-bottom: 20px;
      text-shadow: 0 0 12px rgba(192,192,255,0.6);
    }

    .email-input {
      width: 80%;
      padding: 18px 25px;
      font-size: 1.2rem;
      border: 1px solid rgba(192,192,255,0.5);
      border-radius: 12px;
      background: rgba(10,15,25,0.9);
      color: #f8f5ea;
      margin: 25px auto;
      display: block;
      transition: all 0.3s ease;
    }

    .email-input:focus {
      outline: none;
      box-shadow: 0 0 20px rgba(192,192,255,0.4);
      border-color: rgba(255,255,255,0.7);
    }

    .email-input:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      background: rgba(10,15,25,0.7);
    }

    .email-input.invalid {
      border-color: #ff6b6b;
      box-shadow: 0 0 10px rgba(255,107,107,0.3);
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .secondary-button {
      padding: 18px 35px;
      font-size: 1.1rem;
      background: linear-gradient(135deg, rgba(192,192,255,0.9), rgba(160,160,220,0.9));
      color: #1a1a2a;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 200px;
      border: 1px solid rgba(192,192,255,0.5);
    }

    .secondary-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(192,192,255,0.4);
      background: linear-gradient(135deg, rgba(210,210,255,0.9), rgba(180,180,230,0.9));
    }

    .secondary-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .text-button {
      background: transparent;
      border: 1px solid rgba(192,192,255,0.5);
      color: #c0c0c0;
      padding: 16px 30px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
    }

    .text-button:hover {
      background: rgba(192,192,255,0.1);
      border-color: rgba(255,255,255,0.7);
      color: #ffffff;
    }

    .text-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #thankYouMsg {
      margin-top: 40px;
      text-align: center;
      padding: 30px;
      background: rgba(10,15,25,0.8);
      border-radius: 15px;
      border: 1px solid rgba(192,192,255,0.3);
    }

    .status-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: rgba(0,0,0,0.95);
      padding: 40px;
      border-radius: 20px;
      border: 2px solid rgba(192,192,255,0.5);
      z-index: 10000;
      text-align: center;
      display: none;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 50px rgba(192,192,255,0.3);
      opacity: 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .status-message h3 {
      color: rgba(192,192,255,0.9);
      font-size: 2rem;
      margin-bottom: 20px;
    }

    .status-message p {
      font-size: 1.2rem;
      line-height: 1.6;
      margin-bottom: 30px;
      color: #f5f7fb;
    }

    .audio-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: rgba(192,192,255,0.2);
      border: 2px solid rgba(192,192,255,0.5);
      border-radius: 50%;
      color: rgba(192,192,255,0.8);
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .audio-toggle:hover {
      background: rgba(192,192,255,0.3);
      transform: scale(1.1);
    }

    .audio-toggle.muted {
      opacity: 0.5;
      border-color: #666;
      color: #666;
    }

    .offline-indicator {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 107, 107, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 0.9rem;
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 10px;
      animation: pulse 2s infinite;
    }

    /* ============ STATI PERGAMENA ORIGINALI ============ */
    /* Pergamena arrotolata */
    .parchment-container.rolled .parchment-wrapper {
      transform: rotateX(90deg) translateY(50px);
      opacity: 0.7;
    }

    .parchment-container.rolled .parchment {
      transform: scaleY(0.1) scaleX(1.2);
      opacity: 0;
      min-height: 0;
      padding: 0;
      transition: all 1s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }

    .parchment-container.rolled .parchment-rolled-edges {
      opacity: 1;
      transform: scaleY(1.5);
    }

    .parchment-container.rolled .parchment-nail {
      transform: scale(1.2);
      box-shadow: 
        0 3px 10px rgba(0,0,0,0.8),
        inset 0 1px 3px rgba(255,255,255,0.5),
        0 0 15px rgba(192,192,255,0.5);
    }

    /* Pergamena con desiderio scritto */
    .parchment.has-text {
      background: 
        linear-gradient(to bottom, 
          #f9f2db 0%, 
          #f6ebcb 15%,
          #eeddb5 40%,
          #e4d1a0 70%,
          #dac48d 100%),
        url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.2' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
      box-shadow: 
        inset 0 0 40px rgba(139, 115, 64, 0.45),
        0 25px 70px rgba(0, 0, 0, 1),
        0 0 0 1px rgba(139, 115, 64, 0.5),
        0 0 25px rgba(192, 192, 255, 0.3);
    }

    /* Progress bar per loading */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(139, 115, 64, 0.3);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #8b7340 0%, #b2995a 50%, #d4b97a 100%);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 3px;
    }

    /* ============ RESPONSIVE DESIGN ORIGINALE ============ */
    @media (max-width: 1024px) {
      .container {
        max-width: 90%;
        margin: 40px auto;
        padding: 30px 20px;
      }
      
      h1 {
        font-size: 2.4rem;
      }
      
      .subtitle {
        font-size: 1.1rem;
      }
      
      .well-image-container {
        height: 280px;
        max-width: 90%;
      }
    }

    @media (max-width: 768px) {
      .container {
        margin: 30px 15px;
        padding: 25px 18px;
        border-radius: 20px;
      }
      
      h1 {
        font-size: 2.2rem;
        letter-spacing: 0.1em;
      }
      
      .header::before,
      .header::after {
        font-size: 1.5rem;
      }
      
      .subtitle {
        font-size: 1rem;
      }
      
      .well-image-container {
        height: 250px;
        max-width: 95%;
        margin: 30px auto 20px;
      }
      
      .libra-constellation {
        right: 5%;
        width: 80px;
        height: 60px;
      }
      
      .parchment {
        min-height: 240px;
        padding: 30px 40px;
        font-size: 1.15rem;
      }
      
      .parchment-nail {
        width: 14px;
        height: 14px;
      }
      
      .parchment-nail.top-left,
      .parchment-nail.top-right {
        top: 6px;
      }
      
      .parchment-nail.bottom-left,
      .parchment-nail.bottom-right {
        bottom: 6px;
      }
      
      /* Bottone moneta - responsive tablet */
      .coin-button {
        padding: 20px 40px;
        font-size: 1.3rem;
        min-height: 70px;
        gap: 15px;
      }
      
      .coin-button .button-text {
        font-size: 1.3rem;
        letter-spacing: 1.5px;
      }
      
      .coin-icon {
        width: 50px;
        height: 50px;
      }
      
      .flying-coin {
        width: 50px;
        height: 50px;
      }
      
      .well-target {
        width: 50px;
        height: 50px;
      }
      
      .confirmation,
      .offer-section {
        padding: 30px 20px;
        margin: 30px auto;
      }
      
      .email-input {
        width: 90%;
        padding: 16px 20px;
      }
      
      .button-group {
        flex-direction: column;
        align-items: center;
      }
      
      .secondary-button,
      .text-button {
        min-width: 250px;
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .container {
        margin: 20px 10px;
        padding: 20px 15px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .header::before,
      .header::after {
        font-size: 1.2rem;
      }
      
      .well-image-container {
        height: 200px;
        max-width: 100%;
      }
      
      .libra-constellation {
        display: none;
      }
      
      .parchment {
        min-height: 220px;
        padding: 25px 35px;
        font-size: 1.05rem;
        line-height: 1.6;
      }
      
      .parchment::placeholder {
        font-size: 1.2rem;
        line-height: 1.3;
      }
      
      .parchment-nail {
        width: 12px;
        height: 12px;
      }
      
      .parchment-nail.top-left,
      .parchment-nail.top-right {
        left: 20px;
        right: 20px;
        top: 4px;
      }
      
      .parchment-nail.bottom-left,
      .parchment-nail.bottom-right {
        left: 20px;
        right: 20px;
        bottom: 4px;
      }
      
      .parchment-rolled-edges {
        left: -5px;
        right: -5px;
        height: 20px;
      }
      
      /* Bottone moneta - responsive mobile */
      .coin-button {
        padding: 16px 25px;
        font-size: 1.1rem;
        flex-direction: column;
        gap: 10px;
        min-height: auto;
        border-radius: 40px;
      }
      
      .coin-button .button-text {
        font-size: 1.1rem;
        letter-spacing: 1px;
        text-align: center;
        line-height: 1.3;
      }
      
      .coin-icon {
        width: 45px;
        height: 45px;
        margin-bottom: 5px;
      }
      
      .flying-coin {
        width: 45px;
        height: 45px;
      }
      
      .well-target {
        width: 45px;
        height: 45px;
      }
      
      .splash-effect {
        width: 90px;
        height: 90px;
      }
      
      .char-count {
        font-size: 0.9rem;
        margin: 10px 0 20px;
      }
      
      .confirmation h2 {
        font-size: 1.8rem;
      }
      
      .confirmation p {
        font-size: 1.1rem;
      }
      
      .offer-title {
        font-size: 1.5rem;
      }
      
      .email-input {
        width: 95%;
        padding: 14px 18px;
        font-size: 1rem;
      }
      
      .status-message {
        padding: 30px 20px;
        width: 95%;
      }
      
      .status-message h3 {
        font-size: 1.6rem;
      }
      
      .status-message p {
        font-size: 1rem;
      }
      
      .audio-toggle {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
        bottom: 15px;
        right: 15px;
      }
      
      .offline-indicator {
        font-size: 0.8rem;
        padding: 8px 15px;
        bottom: 15px;
        left: 15px;
        max-width: calc(100% - 30px);
      }
      
      .offline-indicator span {
        display: block;
        text-align: center;
        line-height: 1.3;
      }
    }

    @media (max-width: 360px) {
      .coin-button {
        padding: 14px 20px;
        font-size: 1rem;
      }
      
      .coin-button .button-text {
        font-size: 1rem;
        letter-spacing: 0.8px;
      }
      
      .coin-icon {
        width: 40px;
        height: 40px;
      }
      
      .flying-coin {
        width: 40px;
        height: 40px;
      }
      
      .well-target {
        width: 40px;
        height: 40px;
      }
      
      .splash-effect {
        width: 80px;
        height: 80px;
      }
      
      .parchment {
        padding: 20px 25px;
        min-height: 200px;
      }
      
      .secondary-button,
      .text-button {
        min-width: 200px;
        padding: 14px 25px;
      }
    }

    /* Orientamento landscape su mobile */
    @media (max-height: 600px) and (orientation: landscape) {
      .container {
        margin: 20px auto;
        padding: 20px;
      }
      
      .well-image-container {
        height: 180px;
        margin: 20px auto 15px;
      }
      
      .parchment {
        min-height: 180px;
        padding: 20px 30px;
      }
      
      .coin-button {
        padding: 12px 30px;
        min-height: 60px;
        margin: 20px auto;
      }
      
      .flying-coin {
        width: 40px;
        height: 40px;
      }
      
      .well-target {
        width: 40px;
        height: 40px;
      }
      
      .char-count {
        margin: 10px 0 15px;
      }
    }
  </style>
</head>
<body>
  <!-- ============ CIELO NOTTURNO ============ -->
  <canvas id="night-sky"></canvas>
  
  <!-- COSTELLAZIONE BILANCIA -->
  <div class="libra-constellation">
    <div class="libra-star"></div>
    <div class="libra-star"></div>
    <div class="libra-star"></div>
    <div class="libra-star"></div>
    <div class="libra-star"></div>
    <div class="libra-line"></div>
    <div class="libra-line"></div>
    <div class="libra-line"></div>
    <div class="libra-line"></div>
  </div>
  
  <div class="balance-background"></div>
  
  <div class="offline-indicator" id="offlineIndicator">
    <i class="fas fa-wifi-slash"></i>
    <span>Connessione assente - Il desiderio sarà salvato localmente</span>
  </div>
  
  <button class="audio-toggle" id="audioToggle">
    <i class="fas fa-volume-up"></i>
  </button>
  
  <div id="loadingMessage" class="status-message">
    <h3><i class="fas fa-spinner fa-spin"></i> INVIO IN CORSO</h3>
    <p>La Dea sta registrando il tuo desiderio nel Libro degli Oracoli...</p>
    <div class="progress-bar" style="display: block; margin-top: 20px;">
      <div class="progress-fill" id="loadingProgress"></div>
    </div>
  </div>
  
  <div id="successMessage" class="status-message">
    <h3><i class="fas fa-check-circle"></i> SUCCESSO!</h3>
    <p>Il desiderio è stato custodito. La stella-bilancia è in viaggio verso di te.</p>
    <button class="secondary-button" onclick="closeMessage()">Continua</button>
  </div>
  
  <div id="errorMessage" class="status-message">
    <h3><i class="fas fa-exclamation-triangle"></i> ATTENZIONE</h3>
    <p id="errorText">Si è verificato un errore. Riprova più tardi.</p>
    <button class="secondary-button" onclick="closeMessage()">Riprova</button>
  </div>
  
  <div class="container">
    
    <header class="header">
      <h1>POZZO DEI DESIDERI</h1>
      <p class="subtitle">Davanti alla Dea Bendata, ogni desiderio ha lo stesso peso</p>
    </header>
    
    <main id="step1">
            <div class="well-image-container">
        <div class="image-inner-wrapper">
          <!-- Cerchio target per l'entrata -->
          <div class="well-target" id="wellTarget"></div>
          <!-- IMMAGINE POZZO -->
          <img src="images/pozzo-desideri.png" 
               alt="Pozzo dei Desideri" 
               class="well-image" 
               id="customWellImage"
               onerror="this.src='https://cdn.pixabay.com/photo/2017/09/16/16/09/well-2756257_1280.png'">
        </div>
      </div>
      
      <div class="wish-form">
        <div class="parchment-container" id="parchmentContainer">
          <div class="parchment-wrapper">
            <div class="parchment-rolled-edges"></div>
            <div class="parchment-age-spots"></div>
            <div class="parchment-nail top-left"></div>
            <div class="parchment-nail top-right"></div>
            <div class="parchment-nail bottom-left"></div>
            <div class="parchment-nail bottom-right"></div>
            <textarea id="wishInput" class="parchment" 
                      placeholder="Scrivi qui il tuo desiderio... ✨
                      
La Dea Bendata ascolta ogni parola
senza giudizio, senza preferenze.
La sua bilancia misura solo l'intensità
con cui lo consegni all'universo."
                      maxlength="500"></textarea>
            <div class="parchment-rolled-edges bottom"></div>
          </div>
          <div class="parchment-progress-bar" id="parchmentProgressBar">
            <div class="parchment-progress-fill" id="parchmentProgressFill"></div>
          </div>
        </div>
        
        <div class="char-count" id="charCountContainer">
          <span id="charCount">0</span>/500 caratteri
        </div>
        
        <button id="throwButton" class="coin-button">
          <!-- Icona moneta ARGENTO con simbolo $ -->
          <svg class="coin-icon" width="60" height="60" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="url(#silverGradient)" stroke="#C0C0C0" stroke-width="4"/>
            <circle cx="50" cy="50" r="35" fill="url(#silverLight)" stroke="#E0E0E0" stroke-width="2"/>
            <ellipse cx="35" cy="35" rx="15" ry="8" fill="rgba(255,255,255,0.5)" filter="url(#shine)"/>
            <text x="50" y="62" font-family="Arial, sans-serif" font-size="36" text-anchor="middle" 
                  fill="#333333" font-weight="bold" letter-spacing="0">$</text>
            <circle cx="50" cy="50" r="47" fill="transparent" stroke="rgba(255,255,255,0.6)" stroke-width="1" stroke-dasharray="2,2"/>
            
            <defs>
              <linearGradient id="silverGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#F8F8F8"/>
                <stop offset="30%" stop-color="#E8E8E8"/>
                <stop offset="70%" stop-color="#D0D0D0"/>
                <stop offset="100%" stop-color="#B8B8B8"/>
              </linearGradient>
              
              <linearGradient id="silverLight" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#FFFFFF"/>
                <stop offset="50%" stop-color="#F0F0F0"/>
                <stop offset="100%" stop-color="#E0E0E0"/>
              </linearGradient>
              
              <filter id="shine">
                <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                <feOffset dx="2" dy="2" result="offsetblur"/>
                <feFlood flood-color="white" flood-opacity="0.5"/>
                <feComposite in2="offsetblur" operator="in"/>
                <feMerge>
                  <feMergeNode/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
          </svg>
          <span class="button-text">GETTA LA TUA MONETA NEL POZZO</span>
        </button>
        
        <p class="privacy-note">
          <i class="fas fa-eye-slash"></i> 
          La Dea è bendata: il tuo desiderio è anonimo e sacro
        </p>
      </div>
    </main>
    
       <div id="step2" class="confirmation">
      <h2><i class="fas fa-star"></i> DESIDERIO ACCETTATO</h2>
      <p class="silver-text">Il pozzo ha ricevuto il tuo desiderio.</p>
      <p>Si è unito ai milioni di speranze che riposano<br>nelle acque profonde del destino.</p>
      <p style="margin-top: 30px; font-style: italic; color: #c0c0c0;">
        "Ora respira profondamente e senti<br>l'eco del tuo desiderio nell'universo."
      </p>
      <div style="margin-top: 40px; text-align: center;">
        <img src="images/moneta-acqua.jpg" alt="Moneta nel pozzo" 
             style="width: 120px; height: 120px; border-radius: 50%; 
                    filter: drop-shadow(0 0 15px rgba(255,215,0,0.6));">
      </div>
    </div>
    
    <div id="step3" class="offer-section">
      <h3 class="offer-title"><i class="fas fa-book"></i> CUSTODIA DEL DESIDERIO</h3>
      
      <p id="offer-text" style="line-height: 1.8; font-size: 1.1rem;">
        Il pozzo offre di custodire il tuo desiderio nel <span class="silver-text">Libro dei Giuramenti</span>.<br>
        Tra 7 notti, una <span class="silver-text">stella cadente</span> ti visiterà per ricordartelo.
      </p>
      
      <form id="emailForm" style="margin-top: 30px;">
        <input type="email" id="userEmailInput" class="email-input" 
               placeholder="la.tua@email.com" 
               required>
        
        <div class="button-group">
          <button type="button" id="submitEmailButton" class="secondary-button">
            <i class="fas fa-scroll"></i> ACCETTO LA CUSTODIA
          </button>
          <button type="button" id="skipButton" class="text-button">
            <i class="fas fa-feather-alt"></i> LASCIALO VOLARE LIBERO
          </button>
        </div>
      </form>
      
            <div id="thankYouMsg" class="hidden">
        <h3 class="silver-text"><i class="fas fa-check-circle"></i> DESIDERIO CUSTODITO!</h3>
        <p style="font-size: 1.2rem; margin: 20px 0;">
          Il pozzo ha accettato la tua offerta.<br>
          La stella cadente arriverà tra 7 cicli lunari.
        </p>
        <div style="margin: 30px 0; text-align: center;">
          <img src="images/libro-antico.jpg" alt="Libro dei desideri" 
               style="width: 120px; height: 100px; 
                      filter: drop-shadow(0 0 15px rgba(139,115,64,0.7));">
        </div>
        <button id="returnHomeButton" class="secondary-button">
          <i class="fas fa-redo"></i> Lancia un altro desiderio
        </button>
      </div>
  
  <!-- ============ I TUOI SUONI MP3 ============ -->
  <!-- Modifica i percorsi src con i nomi dei tuoi file MP3 -->
  <audio id="sottofondo" preload="auto" loop>
    <source src="sounds/sottofondo.mp3" type="audio/mpeg">
  </audio>
  
  <audio id="errore" preload="auto">
    <source src="sounds/errore.mp3" type="audio/mpeg">
  </audio>
  
  <audio id="moneta-acqua" preload="auto">
    <source src="sounds/moneta-acqua.mp3" type="audio/mpeg">
  </audio>
  
  <audio id="invio-mail" preload="auto">
    <source src="sounds/invio-mail.mp3" type="audio/mpeg">
  </audio>

<audio id="libero-suono" preload="auto">
  <source src="sounds/libero.mp3" type="audio/mpeg">
</audio>

  <!-- PULSANTE INVISIBILE PER SBLOCCARE AUDIO -->
  <button id="autoAudioUnlocker" 
          style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: default; z-index: 9999; display: none;"
          onclick="this.style.display='none'">
  </button>
  
  <script>
    // ============ SISTEMA AUDIO SEMPLIFICATO ============
    const AudioSystem = {
      audioEnabled: true,
      initialized: false,
      
      init() {
        console.log("🎵 Inizializzazione sistema audio...");
        
        // Carica tutti gli audio
        this.loadAllAudio();
        
        // Inizializza l'icona audio
        this.initAudioToggle();
        
        // Tenta di avviare la musica dopo 500ms
        setTimeout(() => {
          this.startBackgroundMusic();
        }, 500);
        
        this.initialized = true;
        console.log("✅ Sistema audio pronto");
      },
      
      loadAllAudio() {
        const audioElements = [
          document.getElementById('sottofondo'),
          document.getElementById('errore'),
          document.getElementById('moneta-acqua'),
          document.getElementById('invio-mail'),
          document.getElementById('libero-suono')
        ];
        
        audioElements.forEach(audio => {
          if (audio) {
            audio.volume = 0.7;
            audio.load();
          }
        });
      },
      
      initAudioToggle() {
        const audioToggle = document.getElementById('audioToggle');
        if (audioToggle) {
          audioToggle.classList.remove('muted');
          audioToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
          
          audioToggle.addEventListener('click', () => {
            this.toggle();
          });
        }
      },
      
      startBackgroundMusic() {
        if (!this.audioEnabled) return;
        
        const sottofondo = document.getElementById('sottofondo');
        if (!sottofondo) return;
        
        // Imposta le proprietà dell'audio
        sottofondo.volume = 0.2;
        sottofondo.loop = true;
        
        // TENTATIVO 1: Riproduci normalmente
        sottofondo.play().then(() => {
          console.log("✅ Musica di sottofondo attivata automaticamente!");
        }).catch(error => {
          console.log("⚠️ Audio bloccato dal browser, provo con click automatico...");
          
          // TENTATIVO 2: Click automatico sul pulsante invisibile
          this.tryAutoClickUnlock();
        });
      },
      
      tryAutoClickUnlock() {
        // Mostra e clicca il pulsante invisibile
        const unlockButton = document.getElementById('autoAudioUnlocker');
        if (unlockButton) {
          unlockButton.style.display = 'block';
          
          // Aspetta un po' e poi clicca
          setTimeout(() => {
            unlockButton.click();
            console.log("🖱️ Click automatico eseguito");
            
            // Tenta di nuovo la riproduzione dopo il click
            setTimeout(() => {
              const sottofondo = document.getElementById('sottofondo');
              if (sottofondo) {
                sottofondo.play().then(() => {
                  console.log("✅ Musica attivata dopo click automatico!");
                  unlockButton.style.display = 'none';
                }).catch(() => {
                  console.log("❌ Ancora bloccato, l'utente dovrà cliccare sul pulsante 🔊");
                  unlockButton.style.display = 'none';
                });
              }
            }, 100);
          }, 100);
        }
      },
      
      playSound(audioId, volume = 0.5) {
        if (!this.audioEnabled) return null;
        
        const audioElement = document.getElementById(audioId);
        if (!audioElement) return null;
        
        try {
          audioElement.volume = volume;
          audioElement.currentTime = 0;
          audioElement.play().catch(() => {});
          return audioElement;
        } catch (error) {
          return null;
        }
      },
      
      playErrore() {
        this.playSound('errore', 0.4);
      },
      
      playMonetaAcqua() {
        this.playSound('moneta-acqua', 0.6);
      },
      
      playInvioMail() {
        this.playSound('invio-mail', 0.5);
      },
      
      toggle() {
        this.audioEnabled = !this.audioEnabled;
        const audioToggle = document.getElementById('audioToggle');
        const sottofondo = document.getElementById('sottofondo');
        
        if (this.audioEnabled) {
          // ATTIVA AUDIO
          audioToggle.classList.remove('muted');
          audioToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
          console.log("🔊 Audio attivato");
          
          if (sottofondo) {
            sottofondo.play().catch(() => {});
          }
        } else {
          // DISATTIVA AUDIO
          audioToggle.classList.add('muted');
          audioToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
          
          if (sottofondo) {
            sottofondo.pause();
          }
          console.log("🔇 Audio disattivato");
        }
        
        return this.audioEnabled;
      }
    };

    // ============ SISTEMA CIELO NOTTURNO ============
    const NightSky = {
      canvas: null,
      ctx: null,
      stars: [],
      shootingStars: [],
      constellations: [],
      
      init() {
        console.log("🌌 Inizializzazione cielo notturno...");
        
        this.canvas = document.getElementById('night-sky');
        this.ctx = this.canvas.getContext('2d');
        
        this.resizeCanvas();
        window.addEventListener('resize', () => this.resizeCanvas());
        
        this.createStars();
        this.createConstellations();
        this.animate();
        this.startRandomShootingStars();
        
        console.log("✅ Cielo notturno creato");
      },
      
      resizeCanvas() {
        if (!this.canvas) return;
        
        const dpr = window.devicePixelRatio || 1;
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        this.canvas.width = width * dpr;
        this.canvas.height = height * dpr;
        this.canvas.style.width = width + 'px';
        this.canvas.style.height = height + 'px';
        
        this.ctx.scale(dpr, dpr);
        this.createStars();
        this.createConstellations();
      },
      
      createStars() {
        this.stars = [];
        const starCount = Math.floor((window.innerWidth * window.innerHeight) / 800);
        
        for (let i = 0; i < starCount; i++) {
          const size = Math.random();
          let starType, starColor;
          
          if (size < 0.7) starType = 'small';
          else if (size < 0.9) starType = 'medium';
          else starType = 'large';
          
          if (Math.random() > 0.9) {
            starColor = Math.random() > 0.5 ? 'blue' : 'yellow';
          }
          
          this.stars.push({
            x: Math.random() * window.innerWidth,
            y: Math.random() * window.innerHeight * 0.8,
            size: starType,
            color: starColor,
            opacity: 0.3 + Math.random() * 0.7,
            twinkleSpeed: 0.5 + Math.random() * 2,
            twinkleOffset: Math.random() * Math.PI * 2
          });
        }
      },
      
      createConstellations() {
        this.constellations = [];
        const constellationCount = 5 + Math.floor(Math.random() * 5);
        
        for (let c = 0; c < constellationCount; c++) {
          const starsInConstellation = 3 + Math.floor(Math.random() * 5);
          const constellationStars = [];
          const baseX = Math.random() * window.innerWidth * 0.7 + window.innerWidth * 0.15;
          const baseY = Math.random() * window.innerHeight * 0.5;
          
          for (let s = 0; s < starsInConstellation; s++) {
            constellationStars.push({
              x: baseX + (Math.random() - 0.5) * 150,
              y: baseY + (Math.random() - 0.5) * 100,
              size: 2 + Math.random() * 2
            });
          }
          
          const lines = [];
          for (let i = 0; i < constellationStars.length - 1; i++) {
            if (Math.random() > 0.3) {
              lines.push({
                x1: constellationStars[i].x,
                y1: constellationStars[i].y,
                x2: constellationStars[i + 1].x,
                y2: constellationStars[i + 1].y,
                length: Math.sqrt(
                  Math.pow(constellationStars[i + 1].x - constellationStars[i].x, 2) +
                  Math.pow(constellationStars[i + 1].y - constellationStars[i].y, 2)
                ),
                angle: Math.atan2(
                  constellationStars[i + 1].y - constellationStars[i].y,
                  constellationStars[i + 1].x - constellationStars[i].x
                )
              });
            }
          }
          
          this.constellations.push({
            stars: constellationStars,
            lines: lines,
            opacity: 0.4 + Math.random() * 0.3
          });
        }
      },
      
      startRandomShootingStars() {
        const scheduleNextStar = () => {
          const minDelay = 2000;
          const maxDelay = 8000;
          const delay = minDelay + Math.random() * (maxDelay - minDelay);
          
          setTimeout(() => {
            if (Math.random() > 0.3) {
              this.createRandomShootingStar();
            }
            scheduleNextStar();
          }, delay);
        };
        
        scheduleNextStar();
        
        setTimeout(() => {
          for (let i = 0; i < 3; i++) {
            setTimeout(() => this.createRandomShootingStar(), i * 300);
          }
        }, 1500);
      },
      
      createRandomShootingStar() {
        const params = this.generateRandomStarParams();
        
        const star = document.createElement('div');
        star.className = 'shooting-star';
        star.style.left = params.startX + 'px';
        star.style.top = params.startY + 'px';
        
        const starSize = params.intensity * 2 + 1;
        star.style.width = starSize + 'px';
        star.style.height = starSize + 'px';
        
        if (Math.random() > 0.8) {
          star.classList.add(Math.random() > 0.5 ? 'blue' : 'yellow');
        } else {
          star.classList.add(params.intensity > 0.7 ? 'medium' : 'small');
        }
        
        const brightness = params.intensity * 0.8 + 0.2;
        star.style.backgroundColor = `rgba(255, 255, 255, ${brightness})`;
        star.style.boxShadow = `
          0 0 ${starSize * 2}px ${starSize}px rgba(255, 255, 255, ${brightness * 0.5}),
          0 0 ${starSize * 4}px ${starSize * 2}px rgba(255, 255, 255, ${brightness * 0.3})
        `;
        
        const trail = document.createElement('div');
        trail.className = 'shooting-star-trail';
        trail.style.left = params.startX + 'px';
        trail.style.top = params.startY + 'px';
        trail.style.transform = `rotate(${params.angle}rad)`;
        trail.style.width = '0px';
        
        const trailOpacity = params.intensity * 0.7;
        trail.style.height = Math.max(1, params.intensity * 2) + 'px';
        trail.style.background = `linear-gradient(90deg, 
          transparent 0%, 
          rgba(255, 255, 255, ${trailOpacity}) 20%, 
          rgba(255, 255, 255, ${trailOpacity * 0.8}) 50%, 
          transparent 100%)`;
        
        document.body.appendChild(star);
        document.body.appendChild(trail);
        
        const distance = Math.sqrt(
          Math.pow(params.endX - params.startX, 2) + 
          Math.pow(params.endY - params.startY, 2)
        );
        
        const duration = params.duration;
        
        star.style.transition = `
          transform ${duration}ms cubic-bezier(0.2, 0.8, 0.4, 1),
          opacity ${duration}ms ease-out
        `;
        
        trail.style.transition = `
          width ${duration}ms linear,
          opacity ${duration * 0.8}ms ease-out
        `;
        
        setTimeout(() => {
          star.style.transform = `translate(${params.endX - params.startX}px, ${params.endY - params.startY}px)`;
          star.style.opacity = '1';
          
          const trailLength = distance * (0.3 + params.intensity * 0.4);
          trail.style.width = trailLength + 'px';
          trail.style.opacity = trailOpacity;
        }, 10);
        
        if (params.intensity > 0.5) {
          const twinkleCount = Math.floor(params.intensity * 5);
          for (let i = 0; i < twinkleCount; i++) {
            setTimeout(() => {
              if (star.parentNode) {
                star.style.boxShadow = `
                  0 0 ${starSize * 3}px ${starSize * 1.5}px rgba(255, 255, 255, ${brightness * 0.8}),
                  0 0 ${starSize * 6}px ${starSize * 3}px rgba(255, 255, 255, ${brightness * 0.4})
                `;
                setTimeout(() => {
                  star.style.boxShadow = `
                    0 0 ${starSize * 2}px ${starSize}px rgba(255, 255, 255, ${brightness * 0.5}),
                    0 0 ${starSize * 4}px ${starSize * 2}px rgba(255, 255, 255, ${brightness * 0.3})
                  `;
                }, 100);
              }
            }, i * (duration / twinkleCount));
          }
        }
        
        setTimeout(() => {
          star.style.opacity = '0';
          trail.style.opacity = '0';
        }, duration - 500);
        
        setTimeout(() => {
          if (star.parentNode) star.parentNode.removeChild(star);
          if (trail.parentNode) trail.parentNode.removeChild(trail);
        }, duration + 100);
      },
      
      generateRandomStarParams() {
        const minAngle = -Math.PI / 3;
        const maxAngle = -Math.PI / 6;
        const angle = minAngle + Math.random() * (maxAngle - minAngle);
        
        const intensity = 0.3 + Math.random() * 0.7;
        
        const speedFactor = 0.8 + Math.random() * 1.2;
        const baseDuration = 3000;
        const duration = baseDuration / speedFactor;
        
        const startX = Math.random() * window.innerWidth;
        const startY = -50 - Math.random() * 100;
        
        const distance = 800 + intensity * 400 + speedFactor * 200;
        
        const endX = startX + Math.cos(angle) * distance;
        const endY = startY + Math.sin(angle) * distance;
        
        return {
          startX,
          startY,
          endX,
          endY,
          angle,
          intensity,
          speedFactor,
          duration: Math.min(Math.max(duration, 1500), 5000)
        };
      },
      
      createShootingStar() {
        const params = this.generateRandomStarParams();
        params.duration = 2000;
        
        const star = document.createElement('div');
        star.className = 'shooting-star';
        star.style.left = params.startX + 'px';
        star.style.top = params.startY + 'px';
        
        const trail = document.createElement('div');
        trail.className = 'shooting-star-trail';
        trail.style.left = params.startX + 'px';
        trail.style.top = params.startY + 'px';
        trail.style.transform = `rotate(${params.angle}rad)`;
        
        document.body.appendChild(star);
        document.body.appendChild(trail);
        
        star.style.animation = `shootingStar ${params.duration}ms linear forwards`;
        trail.style.animation = `trailGrow ${params.duration}ms linear forwards`;
        
        setTimeout(() => {
          if (star.parentNode) star.parentNode.removeChild(star);
          if (trail.parentNode) trail.parentNode.removeChild(trail);
        }, params.duration);
      },
      
      animate() {
        if (!this.ctx || !this.canvas) return;
        
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        const time = Date.now() / 1000;
        
        this.stars.forEach(star => {
          const twinkle = Math.sin(time * star.twinkleSpeed + star.twinkleOffset) * 0.3 + 0.7;
          const currentOpacity = star.opacity * twinkle;
          
          this.ctx.beginPath();
          
          if (star.color === 'blue') {
            this.ctx.fillStyle = `rgba(182, 208, 255, ${currentOpacity})`;
          } else if (star.color === 'yellow') {
            this.ctx.fillStyle = `rgba(255, 249, 182, ${currentOpacity})`;
          } else {
            this.ctx.fillStyle = `rgba(255, 255, 255, ${currentOpacity})`;
          }
          
          let radius;
          if (star.size === 'small') radius = 0.5;
          else if (star.size === 'medium') radius = 1;
          else radius = 1.5;
          
          if (star.size === 'large') {
            const gradient = this.ctx.createRadialGradient(
              star.x, star.y, 0,
              star.x, star.y, radius * 3
            );
            
            if (star.color === 'blue') {
              gradient.addColorStop(0, `rgba(182, 208, 255, ${currentOpacity})`);
              gradient.addColorStop(1, 'rgba(182, 208, 255, 0)');
            } else if (star.color === 'yellow') {
              gradient.addColorStop(0, `rgba(255, 249, 182, ${currentOpacity})`);
              gradient.addColorStop(1, 'rgba(255, 249, 182, 0)');
            } else {
              gradient.addColorStop(0, `rgba(255, 255, 255, ${currentOpacity})`);
              gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            }
            
            this.ctx.fillStyle = gradient;
            this.ctx.arc(star.x, star.y, radius * 3, 0, Math.PI * 2);
            this.ctx.fill();
          }
          
          this.ctx.beginPath();
          this.ctx.arc(star.x, star.y, radius, 0, Math.PI * 2);
          
          if (star.color === 'blue') {
            this.ctx.fillStyle = `rgba(182, 208, 255, ${currentOpacity})`;
          } else if (star.color === 'yellow') {
            this.ctx.fillStyle = `rgba(255, 249, 182, ${currentOpacity})`;
          } else {
            this.ctx.fillStyle = `rgba(255, 255, 255, ${currentOpacity})`;
          }
          
          this.ctx.fill();
        });
        
        requestAnimationFrame(() => this.animate());
      }
    };

    // ============ SISTEMA ANIMAZIONE MONETA ============
    const CoinAnimation = {
      createDirectFlight(startX, startY, endX, endY) {
        const deltaX = endX - startX;
        const deltaY = endY - startY;
        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        const angle = Math.atan2(deltaY, deltaX);
        
        const coin = document.createElement('div');
        coin.className = 'flying-coin';
        coin.style.left = startX + 'px';
        coin.style.top = startY + 'px';
        coin.style.setProperty('--start-x', '0px');
        coin.style.setProperty('--start-y', '0px');
        coin.style.setProperty('--end-x', deltaX + 'px');
        coin.style.setProperty('--end-y', deltaY + 'px');
        coin.style.setProperty('--delta-x', deltaX + 'px');
        coin.style.setProperty('--delta-y', deltaY + 'px');
        
        coin.innerHTML = `
          <svg width="60" height="60" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="url(#silverGradient)" stroke="#C0C0C0" stroke-width="4"/>
            <circle cx="50" cy="50" r="35" fill="url(#silverLight)" stroke="#E0E0E0" stroke-width="2"/>
            <ellipse cx="35" cy="35" rx="15" ry="8" fill="rgba(255,255,255,0.5)" filter="url(#shine)"/>
            <text x="50" y="62" font-family="Arial, sans-serif" font-size="36" text-anchor="middle" 
                  fill="#333333" font-weight="bold" letter-spacing="0">$</text>
            <circle cx="50" cy="50" r="47" fill="transparent" stroke="rgba(255,255,255,0.6)" stroke-width="1" stroke-dasharray="2,2"/>
          </svg>
        `;
        
        document.body.appendChild(coin);
        
        const trail = document.createElement('div');
        trail.className = 'coin-trail';
        trail.style.left = startX + 'px';
        trail.style.top = startY + 'px';
        trail.style.setProperty('--angle', angle + 'rad');
        trail.style.setProperty('--distance', distance + 'px');
        
        document.body.appendChild(trail);
        
        const target = document.getElementById('wellTarget');
        if (target) {
          target.style.left = (endX - 30) + 'px';
          target.style.top = (endY - 30) + 'px';
          target.style.opacity = '0.5';
        }
        
        setTimeout(() => {
          coin.style.animation = 'coinDirectFlight 1500ms linear forwards';
          trail.style.animation = 'trailDirectGrow 1500ms linear forwards';
        }, 10);
        
        setTimeout(() => {
          this.createSplashEffect(endX, endY);
          if (target) target.style.opacity = '0';
        }, 1400);
        
        setTimeout(() => {
          if (coin.parentNode) coin.parentNode.removeChild(coin);
          if (trail.parentNode) trail.parentNode.removeChild(trail);
        }, 1600);
        
        return { coin, trail };
      },
      
      createSplashEffect(x, y) {
        const splash = document.createElement('div');
        splash.className = 'splash-effect';
        splash.style.left = (x - 60) + 'px';
        splash.style.top = (y - 60) + 'px';
        
        document.body.appendChild(splash);
        
        setTimeout(() => {
          splash.style.animation = 'splashEffect 800ms ease-out forwards';
        }, 10);
        
        setTimeout(() => {
          if (splash.parentNode) splash.parentNode.removeChild(splash);
        }, 900);
      }
    };

    // ============ SISTEMA PERGAMENA ============
    const ParchmentSystem = {
      parchment: null,
      container: null,
      wrapper: null,
      progressBar: null,
      progressFill: null,
      charCount: null,
      charCountContainer: null,
      
      init() {
        this.parchment = document.getElementById('wishInput');
        this.container = document.getElementById('parchmentContainer');
        this.wrapper = this.container.querySelector('.parchment-wrapper');
        this.progressBar = document.getElementById('parchmentProgressBar');
        this.progressFill = document.getElementById('parchmentProgressFill');
        this.charCount = document.getElementById('charCount');
        this.charCountContainer = document.getElementById('charCountContainer');
        
        if (!this.parchment) {
          console.error("❌ Pergamena non trovata!");
          return;
        }
        
        this.setupEventListeners();
        this.updateCharCount();
        
        console.log("📜 Sistema pergamena inizializzato");
      },
      
      setupEventListeners() {
        this.parchment.addEventListener('input', () => {
          this.updateCharCount();
          this.updateProgressBar();
          this.updateParchmentEffects();
        });
        
        this.parchment.addEventListener('focus', () => {
          this.parchment.style.animation = 'parchmentGlow 2s infinite alternate';
          this.container.classList.remove('rolled');
        });
        
        this.parchment.addEventListener('blur', () => {
          this.parchment.style.animation = '';
        });
        
        this.parchment.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const throwButton = document.getElementById('throwButton');
            if (throwButton && !throwButton.disabled) {
              throwButton.click();
            }
          }
        });
      },
      
      updateCharCount() {
        const length = this.parchment.value.length;
        this.charCount.textContent = length;
        
        if (length > 450) {
          this.charCountContainer.style.color = '#ff6b6b';
          this.charCount.style.fontWeight = 'bold';
          this.charCountContainer.style.textShadow = '0 0 15px rgba(255, 107, 107, 0.5)';
        } else if (length > 400) {
          this.charCountContainer.style.color = '#ffa726';
          this.charCount.style.fontWeight = 'bold';
          this.charCountContainer.style.textShadow = '0 0 15px rgba(255, 167, 38, 0.5)';
        } else if (length > 0) {
          this.charCountContainer.style.color = '#b2995a';
          this.charCount.style.fontWeight = 'normal';
          this.charCountContainer.style.textShadow = '0 0 10px rgba(178, 153, 90, 0.5)';
        } else {
          this.charCountContainer.style.color = '#a0a8c0';
          this.charCount.style.fontWeight = 'normal';
          this.charCountContainer.style.textShadow = 'none';
        }
      },
      
      updateProgressBar() {
        const length = this.parchment.value.length;
        const percentage = (length / 500) * 100;
        
        if (length > 0) {
          this.progressBar.style.display = 'block';
          this.progressFill.style.width = `${percentage}%`;
          
          if (percentage > 90) {
            this.progressFill.style.background = 'linear-gradient(90deg, #ff6b6b 0%, #ff8e8e 50%, #ffaaaa 100%)';
          } else if (percentage > 80) {
            this.progressFill.style.background = 'linear-gradient(90deg, #ffa726 0%, #ffb74d 50%, #ffcc80 100%)';
          } else {
            this.progressFill.style.background = 'linear-gradient(90deg, #8b7340 0%, #b2995a 50%, #d4b97a 100%)';
          }
        } else {
          this.progressBar.style.display = 'none';
        }
      },
      
      updateParchmentEffects() {
        const length = this.parchment.value.length;
        
        if (length > 0) {
          this.parchment.classList.add('has-text');
          
          if (length > 450) {
            this.parchment.style.boxShadow = 
              'inset 0 0 40px rgba(255, 107, 107, 0.3), ' +
              'inset 15px 0 25px -15px rgba(255, 107, 107, 0.7), ' +
              'inset -15px 0 25px -15px rgba(255, 107, 107, 0.7), ' +
              '0 25px 70px rgba(0, 0, 0, 1), ' +
              '0 0 0 1px rgba(255, 107, 107, 0.5), ' +
              '0 0 30px rgba(255, 107, 107, 0.4)';
          } else if (length > 400) {
            this.parchment.style.boxShadow = 
              'inset 0 0 40px rgba(255, 167, 38, 0.3), ' +
              'inset 15px 0 25px -15px rgba(255, 167, 38, 0.7), ' +
              'inset -15px 0 25px -15px rgba(255, 167, 38, 0.7), ' +
              '0 25px 70px rgba(0, 0, 0, 1), ' +
              '0 0 0 1px rgba(255, 167, 38, 0.5), ' +
              '0 0 30px rgba(255, 167, 38, 0.4)';
          } else {
            this.parchment.style.boxShadow = 
              'inset 0 0 40px rgba(139, 115, 64, 0.45), ' +
              'inset 15px 0 25px -15px rgba(139, 115, 64, 0.7), ' +
              'inset -15px 0 25px -15px rgba(139, 115, 64, 0.7), ' +
              '0 25px 70px rgba(0, 0, 0, 1), ' +
              '0 0 0 1px rgba(139, 115, 64, 0.5), ' +
              '0 0 25px rgba(192, 192, 255, 0.3)';
          }
        } else {
          this.parchment.classList.remove('has-text');
          this.parchment.style.boxShadow = '';
        }
      },
      
      rollUp() {
        return new Promise((resolve) => {
          console.log("📜 La pergamena si sta arrotolando...");
          
          this.parchment.disabled = true;
          this.parchment.style.cursor = 'default';
          this.progressBar.style.display = 'none';
          this.container.classList.add('rolled');
          
          setTimeout(() => {
            // Suono magico durante l'arrotolamento
            AudioSystem.playSound('invio-mail', 0.3);
          }, 300);
          
          setTimeout(() => {
            this.container.style.transform = 'translateY(-20px)';
            setTimeout(() => {
              this.container.style.transform = 'translateY(0)';
            }, 300);
          }, 600);
          
          setTimeout(() => {
            console.log("✅ Pergamena arrotolata!");
            resolve();
          }, 1200);
        });
      },
      
      reset() {
        this.container.classList.remove('rolled');
        this.parchment.disabled = false;
        this.parchment.style.cursor = 'text';
        this.parchment.classList.remove('has-text');
        this.parchment.style.boxShadow = '';
        this.container.style.transform = '';
        this.clear();
      },
      
      clear() {
        this.parchment.value = '';
        this.updateCharCount();
        this.updateProgressBar();
        this.updateParchmentEffects();
      },
      
      getValue() {
        return this.parchment.value.trim();
      },
      
      isValid() {
        const value = this.getValue();
        return value.length >= 5 && value.length <= 500;
      },
      
      getValidationError() {
        const value = this.getValue();
        if (value.length < 5) return "Scrivi un desiderio di almeno 5 caratteri!";
        if (value.length > 500) return "Il desiderio è troppo lungo!";
        return "";
      }
    };

    // ============ VARIABILI GLOBALI ============
    let isOnline = navigator.onLine;
    let pendingWishes = [];

    // ============ ELEMENTI DOM ============
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const throwButton = document.getElementById('throwButton');
    const submitEmailButton = document.getElementById('submitEmailButton');
    const skipButton = document.getElementById('skipButton');
    const userEmailInput = document.getElementById('userEmailInput');
    const thankYouMsg = document.getElementById('thankYouMsg');
    const returnHomeButton = document.getElementById('returnHomeButton');
    const audioToggle = document.getElementById('audioToggle');
    const offlineIndicator = document.getElementById('offlineIndicator');
    const loadingProgress = document.getElementById('loadingProgress');
    const errorText = document.getElementById('errorText');
    const wellImageContainer = document.querySelector('.well-image-container');

    // ============ FUNZIONI MESSAGGI ============
    function showMessage(element) {
      element.style.display = 'block';
      setTimeout(() => {
        element.style.opacity = '1';
        element.style.transform = 'translate(-50%, -50%) scale(1)';
      }, 10);
    }

    function hideMessage(element) {
      element.style.opacity = '0';
      element.style.transform = 'translate(-50%, -50%) scale(0.9)';
      setTimeout(() => {
        element.style.display = 'none';
      }, 300);
    }

    function closeMessage() {
      const loadingMessage = document.getElementById('loadingMessage');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');
      hideMessage(loadingMessage);
      hideMessage(successMessage);
      hideMessage(errorMessage);
    }

    function showError(message) {
      errorText.textContent = message;
      showMessage(errorMessage);
    }

    // ============ VALIDAZIONE EMAIL ============
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // ============ GESTIONE OFFLINE ============
    function updateOnlineStatus() {
      isOnline = navigator.onLine;
      offlineIndicator.style.display = isOnline ? 'none' : 'flex';
      if (isOnline) retryPendingWishes();
    }

    function saveWishLocally(wish, email = null) {
      try {
        const wishData = { wish, email, timestamp: new Date().toISOString() };
        pendingWishes.push(wishData);
        localStorage.setItem('pendingWishes', JSON.stringify(pendingWishes));
        return wishData;
      } catch (e) {
        return null;
      }
    }

    async function retryPendingWishes() {
      try {
        const storedWishes = localStorage.getItem('pendingWishes');
        if (storedWishes) pendingWishes = JSON.parse(storedWishes);
        
        if (pendingWishes.length > 0 && isOnline) {
          for (let i = 0; i < pendingWishes.length; i++) {
            const wishData = pendingWishes[i];
            try {
              await sendWishToServer(wishData);
              pendingWishes.splice(i, 1);
              i--;
            } catch (error) {}
          }
          localStorage.setItem('pendingWishes', JSON.stringify(pendingWishes));
        }
      } catch (error) {}
    }

    // ============ INVIO DATI AL SERVER ============
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbw126YUNifMB95tjpfqAgzZrdI40-Ox6KswjyrGvjJkzYYRrnaqHk5mKJnCQG7kXYoW_A/exec';

    async function sendWishToServer(wishData) {
      if (!isOnline) throw new Error('offline');
      
      showMessage(document.getElementById('loadingMessage'));
      updateProgress(0);
      
      try {
        const progressInterval = setInterval(() => {
          const currentProgress = parseInt(loadingProgress.style.width || '0');
          if (currentProgress < 90) updateProgress(currentProgress + 10);
        }, 300);
        
        const formData = new FormData();
        formData.append('email', wishData.email || '');
        formData.append('wish_text', wishData.wish);
        formData.append('timestamp', wishData.timestamp);
        formData.append('action', wishData.email ? 'register' : 'anonymous');
        
        await fetch(ENDPOINT, {
          method: 'POST',
          body: formData,
          mode: 'no-cors'
        });
        
        clearInterval(progressInterval);
        updateProgress(100);
        hideMessage(document.getElementById('loadingMessage'));
        showMessage(document.getElementById('successMessage'));
        // Suono di successo per l'invio
        AudioSystem.playInvioMail();
        
        return true;
      } catch (error) {
        hideMessage(document.getElementById('loadingMessage'));
        if (error.message === 'offline' || !isOnline) {
          showError("Connessione assente. Desiderio salvato localmente.");
          saveWishLocally(wishData.wish, wishData.email);
        } else {
          showError("Errore. Riprova più tardi.");
        }
        return false;
      }
    }

    function updateProgress(percentage) {
      if (loadingProgress) loadingProgress.style.width = `${percentage}%`;
    }

    // ============ FLUSSO PRINCIPALE ============
    async function throwWish() {
      const error = ParchmentSystem.getValidationError();
      if (error) {
        showError(error);
        // SUONO DI ERRORE quando il desiderio è troppo corto
        AudioSystem.playErrore();
        
        const parchmentContainer = document.getElementById('parchmentContainer');
        parchmentContainer.classList.add('shake');
        setTimeout(() => parchmentContainer.classList.remove('shake'), 500);
        return;
      }
      
      const wish = ParchmentSystem.getValue();
      
      throwButton.disabled = true;
      throwButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> INVIO IN CORSO...';
      
      // SUONO DEL LANCIO MONETA
      AudioSystem.playSound('invio-mail', 0.3);
      
      const buttonRect = throwButton.getBoundingClientRect();
      const wellRect = wellImageContainer.getBoundingClientRect();
      
      const startX = buttonRect.left + buttonRect.width / 2;
      const startY = buttonRect.top + buttonRect.height / 2;
      const endX = wellRect.left + wellRect.width / 2;
      const endY = wellRect.top + wellRect.height * 0.7;
      
      CoinAnimation.createDirectFlight(startX, startY, endX, endY);
      ParchmentSystem.rollUp();
      
      setTimeout(() => {
        // SUONO MONETA CHE CADE IN ACQUA
        AudioSystem.playMonetaAcqua();
      }, 1300);
      
      for (let i = 0; i < 3; i++) {
        setTimeout(() => NightSky.createShootingStar(), i * 400);
      }
      
      setTimeout(() => {
        step1.classList.add('fade-out');
        setTimeout(() => {
          step1.style.display = 'none';
          step2.style.display = 'block';
          
          sessionStorage.setItem('currentWish', wish);
          
          setTimeout(() => {
            step2.classList.add('fade-out');
            setTimeout(() => {
              step2.style.display = 'none';
              step3.style.display = 'block';
              
              throwButton.disabled = false;
              throwButton.innerHTML = `
                <svg class="coin-icon" width="60" height="60" viewBox="0 0 100 100">
                  <circle cx="50" cy="50" r="45" fill="url(#silverGradient)" stroke="#C0C0C0" stroke-width="4"/>
                  <circle cx="50" cy="50" r="35" fill="url(#silverLight)" stroke="#E0E0E0" stroke-width="2"/>
                  <ellipse cx="35" cy="35" rx="15" ry="8" fill="rgba(255,255,255,0.5)" filter="url(#shine)"/>
                  <text x="50" y="62" font-family="Arial, sans-serif" font-size="36" text-anchor="middle" 
                        fill="#333333" font-weight="bold" letter-spacing="0">$</text>
                  <circle cx="50" cy="50" r="47" fill="transparent" stroke="rgba(255,255,255,0.6)" stroke-width="1" stroke-dasharray="2,2"/>
                </svg>
                <span class="button-text">GETTA LA TUA MONETA NEL POZZO</span>
              `;
            }, 800);
          }, 4000);
        }, 800);
      }, 1500);
    }

    function submitEmail() {
      const email = userEmailInput.value.trim();
      const wish = sessionStorage.getItem('currentWish') || '';
      
      if (!email || !validateEmail(email)) {
        showError("Inserisci un'email valida!");
        userEmailInput.classList.add('invalid');
        // SUONO DI ERRORE per email non valida
        AudioSystem.playErrore();
        return;
      }
      
      userEmailInput.disabled = true;
      submitEmailButton.disabled = true;
      skipButton.disabled = true;
      
      const wishData = { wish, email, timestamp: new Date().toISOString() };
      
      sendWishToServer(wishData).then(success => {
        if (success) {
          document.getElementById('emailForm').style.display = 'none';
          thankYouMsg.classList.remove('hidden');
          sessionStorage.removeItem('currentWish');
        } else {
          userEmailInput.disabled = false;
          submitEmailButton.disabled = false;
          skipButton.disabled = false;
        }
      });
    }

    function skipRegistration() {
      const wish = sessionStorage.getItem('currentWish') || '';
      
      submitEmailButton.disabled = true;
      skipButton.disabled = true;
      
      // SUONO "LASCIALO VOLARE LIBERO"
      AudioSystem.playSound('libero-suono', 0.5);
      
      const wishData = { wish, timestamp: new Date().toISOString() };
      
      sendWishToServer(wishData).then(success => {
        if (success) {
          document.querySelector('.container').classList.add('fade-out');
          setTimeout(() => {
            document.body.innerHTML = createFinalPage();
          }, 800);
        } else {
          submitEmailButton.disabled = false;
          skipButton.disabled = false;
        }
      });
    }

        function createFinalPage() {
      return `
        <div style="text-align: center; padding: 100px 20px; color: white; background: radial-gradient(circle at top, #0a0e1a 0%, #050811 100%); min-height: 100vh;">
          <div style="margin-bottom: 30px; text-align: center;">
            <img src="images/stella.jpg" alt="Desiderio liberato" 
                 style="width: 150px; height: 100px; 
                        filter: drop-shadow(0 0 20px rgba(255,255,255,0.5));">
          </div>
          <h1 style="font-family: 'Cinzel', serif; font-size: 2.5rem; margin-bottom: 30px; color: #e0e0e0;">
            DESIDERIO LIBERATO
          </h1>
          <h1 style="font-family: 'Cinzel', serif; font-size: 2.5rem; margin-bottom: 30px; color: #e0e0e0;">
            DESIDERIO LIBERATO
          </h1>
          <p style="font-size: 1.3rem; max-width: 600px; margin: 0 auto 40px; line-height: 1.8;">
            Il tuo desiderio viaggia libero nell'universo.
          </p>
          <p style="margin-top: 50px;">
            <a href="/" style="color: #e0e0e0; text-decoration: none; border: 2px solid #e0e0e0; padding: 15px 30px; border-radius: 10px; display: inline-block; font-size: 1.1rem; font-family: 'Cinzel', serif;">
              ✨ Lancia un altro desiderio
            </a>
          </p>
        </div>
      `;
    }

    // ============ INIZIALIZZAZIONE ============
    document.addEventListener('DOMContentLoaded', () => {
      console.log("🚀 Avvio Pozzo dei Desideri...");
      
      // 1. Inizializza sistema audio PER PRIMA COSA
      AudioSystem.init();
      
      // 2. Inizializza cielo notturno
      NightSky.init();
      
      // 3. Inizializza sistema pergamena
      ParchmentSystem.init();
      
      // 4. Bottone getta desiderio
      throwButton.addEventListener('click', throwWish);
      
      // 5. Gestione email
      submitEmailButton.addEventListener('click', submitEmail);
      userEmailInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitEmail();
        }
      });
      userEmailInput.addEventListener('input', () => {
        userEmailInput.classList.remove('invalid');
      });
      
      // 6. Bottone salta
      skipButton.addEventListener('click', skipRegistration);
      
      // 7. Bottone ricomincia
      returnHomeButton.addEventListener('click', () => {
        location.reload();
      });
      
      // 8. Gestione connessione
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();
      
      // 9. Carica desideri pendenti
      try {
        const storedWishes = localStorage.getItem('pendingWishes');
        if (storedWishes) pendingWishes = JSON.parse(storedWishes);
      } catch (error) {}
      
      // 10. TENTATIVO FINALE PER AUDIO DOPO 2 SECONDI
      setTimeout(() => {
        console.log("⚡ Tentativo finale per attivare l'audio...");
        const sottofondo = document.getElementById('sottofondo');
        if (sottofondo && sottofondo.paused) {
          sottofondo.play().then(() => {
            console.log("✅ Musica finalmente attivata!");
          }).catch(() => {
            console.log("ℹ️ Audio disponibile solo cliccando sull'icona 🔊");
          });
        }
      }, 2000);
      
      console.log("✅ App completamente inizializzata");
    });

    // ============ FUNZIONI GLOBALI ============
    window.closeMessage = closeMessage;
    window.addMoreStars = function(count) {
      NightSky.addMoreStars(count);
    };
    window.createShootingStar = function() {
      NightSky.createShootingStar();
    };
  </script>
</body>
</html>